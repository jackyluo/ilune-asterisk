;dialplan_app_record.conf.conf file 
;_98.
[app-recording]
exten=>s,1,NoOp();
same=>n,Set(EXT=${ARG1});
;;;${EXTEN:x:y}, where x is the starting position and y is the number of digits to return.
;;;${EXTEN:x}, would give us everything after the x digit.

;;;98[0-5] - play call mixmonitor record file

;;;987 - play recording file by file name
;;;988 - recording new wav
;;;989 - recording wav and override old file
same=>n,Set(ACTION_ID=${EXT:2:1});

same=>n,Set(CHAN_TYPE=${CHANNEL(CHANNELTYPE)})
same=>n,GotoIf($["${CHAN_TYPE}" = "DAHDI"]?_dahdi)
;ask for password
same=>n,Set(CHAN_NAME=${CHAN_TYPE}/${CHANNEL(peername)})
same=>n,Goto(_auth);
;same=>n(_dahdi),Set(CHAN_NAME=${CHAN_TYPE}/${CHANNEL(dahdi_channel)})
same=>n(_dahdi),Set(CHAN_NAME=${CHAN_TYPE}/${CALLERID(num)})

same=>n(_auth),Verbose(1,CHAN_NAME:${CHAN_NAME});
same=>n,GotoIf($["${ACTION_ID}" = "0"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "1"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "2"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "3"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "4"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "5"]?_auth_play-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "6"]?_auth_play-wav); 

same=>n,GotoIf($["${ACTION_ID}" = "7"]?_auth_rec-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "8"]?_auth_rec-wav); 
same=>n,GotoIf($["${ACTION_ID}" = "9"]?_auth_rec-wav); 

same=>n(_auth_play-wav),Set(CHAN_AUTH_PLAY_WAV=${ODBC_CHAN_AUTH_PLAY_WAV(${CHAN_NAME})});
same=>n,Verbose(1,CHAN_AUTH_PLAY_WAV:${CHAN_AUTH_PLAY_WAV});
same=>n,GotoIf($["NULL${CHAN_AUTH_PLAY_WAV}" = "NULL"]?_no_play_permit)
;启动收听通话录音的终端认证功能
;open the playing call wav chan auth
same=>n,Authenticate(${CHAN_AUTH_PLAY_WAV})
same=>n,Goto(_switch);

same=>n(_auth_rec-wav),Set(CHAN_AUTH_REC_WAV=${ODBC_CHAN_AUTH_REC_WAV(${CHAN_NAME})});
same=>n,Verbose(1,CHAN_AUTH_REC_WAV:${CHAN_AUTH_REC_WAV});
same=>n,GotoIf($["NULL${CHAN_AUTH_REC_WAV}" = "NULL"]?_no_rec_permit)
;启动录制IVR录音的终端认证功能
;open the IVR recording chan auth
same=>n,Authenticate(${CHAN_AUTH_REC_WAV})

same=>n(_switch),NoOp();

same=>n,GotoIf($["${ACTION_ID}" = "0"]?_goto_app-recording-980); 

same=>n,GotoIf($["${ACTION_ID}" = "7"]?_play-wav-file_by_name); 
same=>n,GotoIf($["${ACTION_ID}" = "8"]?_make-wav-file); 
same=>n,GotoIf($["${ACTION_ID}" = "9"]?_make-wav-file-and-override-the-old); 

same=>n(_play-call-monitor-file),   Gosub(app-recording-play-call-monitor-record-file,s,1);

same=>n(_goto_app-recording-980),  Gosub(app-recording-980,s,1);

same=>n(_play-wav-file_by_name),   Gosub(app-recording-play-wav-file-made-by-phone_4name,s,1);
same=>n(_make-wav-file),  Gosub(app-recording-make-wav-file,s,1);
same=>n(_make-wav-file-and-override-the-old),  Gosub(app-recording-make-wav-file-override,s,1);


same=>n(_no_play_permit),NoOp();
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_chan_auth_code_for_play_wav_not_found)
same=>n,Goto(_exit);
same=>n(_no_rec_permit),NoOp();
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/peer_no_rec_wav_permit)
same=>n(_exit),hangup;
;
;
;;---------app-recording play wav file that generated by mix/monitor app ----------
;_980
;
[app-recording-play-call-monitor-record-file]
exten=>s,1,NoOp();
same=>n,Set(WAVDIR=/var/lib/asterisk/wav_sounds/ivr_recording)
same=>n,Set(SPOOLDIR=/var/spool/asterisk/monitor) 


same=>n,Read(FILE_ID,${WAVDIR}/_prompt_call_uid,20)
same=>n(next_more),GotoIf($["NULL${FILE_ID}" = "NULL"]?_exit); 
same=>n,Set(FILE_ID=${ODBC_STR_REPLACE(${FILE_ID},*,.)}); 
same=>n,Verbose(1,FILE_ID:${FILE_ID}); 
same=>n,Set(FILE_ID=${ODBC_CDR_RECORDFILE(${FILE_ID})})

same=>n,GotoIf($["NULL_${FILE_ID}" = "NULL_"]?_exit); 

;same=>n,SayDigits(${FILE_ID})
;STAT():Does a check on the specified file.
same => n,GotoIf($[${STAT(f,${SPOOLDIR}/${FILE_ID}.wav)} = 0]?input_more:play_file)

same=>n(play_file),Playback(${SPOOLDIR}/${FILE_ID})

;play more 
same=>n(input_more),Wait(2)
same=>n,Read(FILE_ID,${WAVDIR}/_prompt_call_uid_more,20)
same=>n,GotoIf($["NULL${FILE_ID}" = "NULL"]?_exit:next_more); 
;same=>n,Hangup()

same=>n(_exit),Playback(${WAVDIR}/_file_not_exist)
same=>n,GotoIf($["1" = "1"]?input_more); 

same=>n,Hangup()



;
;
;;---------app-recording play wav file of that made by phone for name----------
;_987
;
[app-recording-play-wav-file-made-by-phone_4name]
exten=>s,1,NoOp();
same=>n,Set(WAVDIR=/var/lib/asterisk/wav_sounds/ivr_recording)
same=>n,Read(FILE_ID,/var/lib/asterisk/wav_sounds/ivr_tips/_prompt_play_wav_file_name,8)
same=>n(start_here),Verbose(1,FILE_ID:${FILE_ID}); 

same=>n,Set(FILE_NAME_EXIST=${ODBC_CFG_FIND_WAV_FILENAME_BY_ID(${FILE_ID})})
same=>n,GotoIf($["NULL${FILE_NAME_EXIST}" = "NULL"]?_not_exist);

same=>n,Playback(${WAVDIR}/${FILE_NAME_EXIST})
same=>n,Goto(_play_another);

same=>n(_not_exist),Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_wav_file_not_exist)
;same=>n(_play_another),Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_prompt_play_wav_file_name_another)
same=>n(_play_another),Read(FILE_ID,/var/lib/asterisk/wav_sounds/ivr_tips/_prompt_play_wav_file_name_another,8)
same=>n,Goto(start_here);

same=>n,Hangup

;
;
;;---------recording: make-wav-file by call 988----------
;
;_988 
;使用终端录制wav文件，
;并保存到/var/lib/asterisk/wav_sounds/ivr_recording，
;同时在表cfg_wavrecording中插入一条记录
[app-recording-make-wav-file]
exten=>s,1,NoOp();
same=>n,Set(WAVDIR=/var/lib/asterisk/wav_sounds/ivr_recording)
;same=>n,Set(FILE_NAME=${ODBC_SYS_DATETIME()})
same=>n,Set(FILE_NAME=${ODBC_GEN_WAV_RECORDING_ID()})

same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_recording_prompt)
same=>n,Set(REC_START=${ODBC_CURRENT_TIMESTAMP()})
same=>n,Record(${WAVDIR}/${FILE_NAME}.wav)
same=>n,Set(REC_END=${ODBC_CURRENT_TIMESTAMP()})
same=>n,Wait(2)
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_recording_file_id)
same=>n,SayDigits(${FILE_NAME})
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_recording_play)
same=>n,Playback(${WAVDIR}/${FILE_NAME})
;INSERT INTO CFG_WAVRECORDING(ID,FILENAME,CHANNEL,UID,CRTTIME)
same=>n(log_node_root),Set(ODBC_CFG_WAV_RECORDING_INSERT()=${FILE_NAME},${CHANNEL(NAME)},${UNIQUEID},${REC_END} - ${REC_START});

;调用/etc/asterisk/grant_ivr_record_wav_rw.sh，修改此文件的读写权限，允许指定用户修改此文件
same=>n,Set(SSH_USERNAME=${ODBC_GET_SSH_USERNAME_4_IVR_WAV()});
same=>n,Set(foo=${SHELL(setfacl -m u:${SSH_USERNAME}:rwx /var/lib/asterisk/wav_sounds/ivr_recording/${FILE_NAME}.wav)})
same=>n,Verbose(1,SHELL call setfacl modify the file ${FILE_NAME}.wav RW to user:${SSH_USERNAME} ${foo});

same=>n,Hangup

;
;_989
;---------make wav and override the old--------------------
;
;
[app-recording-make-wav-file-override]
exten=>s,1,NoOp();
same=>n,Set(WAVDIR=/var/lib/asterisk/wav_sounds/ivr_recording)
;same=>n,Set(FILE_ID=17032909)
same=>n,Read(FILE_ID,/var/lib/asterisk/wav_sounds/ivr_tips/_prompt_existing_wav_file_name,8)
same=>n,Verbose(1,FILE_ID: ${FILE_ID} );
same=>n,SayDigits(${FILE_ID})
same=>n,Set(FILE_NAME_EXIST=${ODBC_CFG_FIND_WAV_FILENAME_BY_ID(${FILE_ID})})
same=>n,GotoIf($["NULL${FILE_NAME_EXIST}" = "NULL"]?_new_wav); 



;---- record wav and override old file----;
same=>n(_exist_wav),Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_play_recording_exist_file)
same=>n,Verbose(1,Play  old file );
same=>n,Playback(${WAVDIR}/${FILE_NAME_EXIST});
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_recording_override_prompt)
same=>n,Verbose(1,start record );
same=>n,Set(REC_START=${ODBC_CURRENT_TIMESTAMP()})
same=>n,Record(${WAVDIR}/${FILE_NAME_EXIST}_new.wav)
same=>n,Set(REC_END=${ODBC_CURRENT_TIMESTAMP()})
same=>n,Verbose(1,record end);
same=>n,Wait(2)
same=>n,Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_recording_play)
same=>n,Playback(${WAVDIR}/${FILE_NAME_EXIST}_new)
same=>n,Verbose(1,played new);
same=>n,read(IF_OVERRIDE,/var/lib/asterisk/wav_sounds/ivr_tips/_recording_wav_override_confirm,1)
same=>n,GotoIf($["${IF_OVERRIDE}" = "9"]?_override); 
same=>n,Hangup

;copy and override
;不能使用python
;same=>n(_override),AGI(/var/lib/asterisk/wav_sounds/recording_wav_override.py,${FILE_NAME_EXIST}_new.wav,${FILE_NAME_EXIST}.wav);
;same=>n(_override),system(/var/lib/asterisk/wav_sounds/recording_wav_override.py,${FILE_NAME_EXIST}_new.wav,${FILE_NAME_EXIST}.wav);
same=>n(_override),system(cp -f ${WAVDIR}/${FILE_NAME_EXIST}_new.wav ${WAVDIR}/${FILE_NAME_EXIST}.wav);

same=>n,Verbose(1,override old file );
same=>n,Set(WAV_DUR= ${REC_END} - ${REC_START});
same=>n,Verbose(1,WAV_DUR: ${WAV_DUR} );

same=>n,Set(ODBC_CFG_WAV_RECORDING_UPDATE(${FILE_NAME})=${CHANNEL(NAME)},${UNIQUEID});

;调用/etc/asterisk/grant_ivr_record_wav_rw.sh，修改此文件的读写权限，允许指定用户修改此文件
same=>n,Set(SSH_USERNAME=${ODBC_GET_SSH_USERNAME_4_IVR_WAV()});
same=>n,Set(foo=${SHELL(setfacl -m u:${SSH_USERNAME}:rwx /var/lib/asterisk/wav_sounds/ivr_recording/${FILE_NAME}.wav)})
same=>n,Verbose(1,SHELL call setfacl modify the file ${FILE_NAME}.wav RW to user:${SSH_USERNAME} ${foo});


same=>n,Hangup


;---- go to record new wav with new ID and Filename----;
same=>n(_new_wav),Playback(/var/lib/asterisk/wav_sounds/ivr_tips/_wav_file_not_exist);
same=>n,Gosub(app-recording-make-wav-file,s,1);

;----980----for test------------
[app-recording-980]
exten=>s,1,NoOp();
same=>n,Set(WAVDIR=/var/lib/asterisk/wav_sounds/ivr_recording)
same=>n,Verbose(1,WAVDIR: ${WAVDIR});
same=>n,answer();
same=>n,Verbose(1,MP3Player:/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file);
same=>n,MP3Player(/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file)
same=>n,Verbose(1,MP3Player:/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file.mp3);
same=>n,MP3Player(/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file.mp3)
same=>n,Verbose(1,MP3Player:/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file.m3u);
same=>n,MP3Player(/var/lib/asterisk/wav_sounds/ivr_recording/_test_mp3_file.m3u)
same=>n,hangup();

